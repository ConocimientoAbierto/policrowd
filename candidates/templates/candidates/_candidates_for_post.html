{% load standing %}
{% load i18n %}

{% comment %}

  The following variables are expected in the context:

    election
    election_data

    post_data.id
    post_data.label
    post_label_shorter

    candidacies
    candidacies_might_stand_again
    candidacies_not_standing_again

    candidates_locked
    show_confirm_result
    show_retract_result
    candidates_list_edits_allowed

    lock_form
    add_candidate_form

  Permission variables from the context processor:

    user_can_upload_documents
    user_can_lock
    user_can_record_results

    user

  Those required by included partials:

    candidates/_person_in_list.html

      c (a candidacy from candidacies, candidacies_might_stand_again, etc.)

    candidates/_source_confirmation.html

      c
      standing (either 'standing' or 'not-standing')
      post_data.id

    official_documents/_post.html

      official_documents
      post_data.label
      post_data.id

{% endcomment %}

{% if election_data.show_official_documents %}
  {% include 'official_documents/_post.html' %}
{% endif %}

<div id="candidates-for-post-{{ post_data.id }}" class="candidates-for-post">

  {% if user_can_lock %}
    <form method="post" action="{% url 'constituency-lock' election=election %}">
      {% csrf_token %}
      {% for field in lock_form %}{{ field }}{% endfor %}
      <input type="submit" class="button small" value="{% if candidates_locked %}Unlock{% else %}Lock{% endif %} candidate list">
      {% if candidates_locked %}
        {% trans "(This list of candidates is currently <strong>locked</strong>.)" %}
      {% else %}
        {% trans "(This list of candidates is currently <strong>unlocked</strong>.)" %}
      {% endif %}
    </form>
  {% else %}
    {% if candidates_locked %}
      <p>{% blocktrans trimmed %}This list of candidates is now <strong>locked</strong>;
      you can still update contact details of candidates, but
      can't change the people standing in this constituency.{% endblocktrans %}</p>
    {% endif %}
  {% endif %}

  {% if user_can_record_results and show_retract_result %}
    <form action="{% url 'retract-winner' election=election post_id=post_id %}" method="post">
      {% csrf_token %}
      <input type="submit" class="button alert" value="{% trans "Unset the current winners, if incorrect" %}">
    </form>
  {% endif %}

  <div class="candidates__known">

    {# Use the post label here, since multiple posts may be used on a page #}
    {% url 'constituency' election=election post_id=post_data.id ignored_slug=post_data.label|slugify as post_url %}
    <h3>{% blocktrans with post_label=post_data.label %}Known candidates for <a href="{{ post_url }}">{{ post_label }}</a>{% endblocktrans %}
    </h3>

    {% with party_lists_in_use=candidacies.party_lists_in_use parties_and_people=candidacies.parties_and_people %}

      {% for party, people in parties_and_people %}

        <div class="party-group {% if party_lists_in_use %}party-list{% else %}no-party-list{% endif %}">

          {% if party_lists_in_use %}
            <h4 class="party-list-header">{{ party.name }}</h4>
            <p class="party-list-description">
              {% if party.total_count %}
                {% trans "Showing the top candidates." %} <a href="{% url 'party-for-post' election=election post_id=post_data.id organization_id=party.id %}">{% blocktrans with count=party.total_count %}See all {{ count }} members on the party list{% endblocktrans %} &raquo;</a>
              {% endif %}
          {% endif %}

          {% for c, candidate_elected in people %}
            {% if forloop.first %}
              <ul class="candidate-list">
            {% endif %}

              <li class="candidates-list__person{% if user_can_record_results %} hover-highlighting{% endif %}{% if candidate_elected %} candidates-list__person__winner{% endif %}">
                {% if candidate_elected %}
                  <h4 class="candidates-list__person__elected-text">{% trans "Winner" %}</h4>
                {% endif %}

                {% include 'candidates/_person_in_list.html' with election=election %}
                {% if user.is_authenticated %}
                <p>
                  {% if candidate_list_edits_allowed %}
                    <a class="button tiny js-toggle-source-confirmation not-standing">{% trans "Not actually standing?" %}</a>
                  {% endif %}
                  <a href="{% url 'person-update' person_id=c.id %}" class="button tiny secondary">{% trans "Edit" %}</a>
                </p>
                {% if candidate_list_edits_allowed %}
                  {% include 'candidates/_source_confirmation.html' with standing='not-standing' action='candidacy-delete' %}
                {% endif %}
                {% endif %}
                {% if user_can_record_results and show_confirm_result and not candidate_elected %}
                  <form class="winner-confirm" action="{% url 'record-winner' election=election post_id=post_data.id %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="person_id" value="{{ c.id }}">
                    <input type="hidden" name="source" value="{% trans "[Quick update from the constituency page]" %}">
                    <input type="submit" class="button" value="{% trans "This candidate was elected!" %}">
                  </form>
                {% endif %}
              </li>

            {% if forloop.last %}
              </ul>
            {% endif %}

          {% endfor %} {# end of 'for c, candidate_elected in people' #}

        </div>

      {% empty %}
        <div class="no-candidates row">
          <p class="medium-8 columns">{% blocktrans trimmed with post_label=post_data.label election_name=election_data.name %}
              <strong>Oh no!</strong> We donâ€™t know of any candidates in {{ post_label }}
          for the {{ election_name }} yet.{% endblocktrans %}</p>
          {% if candidate_list_edits_allowed %}
            <p class="medium-4 columns"><a class="show-new-candidate-form button">{% trans "Add a new candidate" %}</a></p>
          {% else %}
            <p class="medium-4 columns"><a href="{% url 'account_login' %}{% if redirect_after_login %}?next={{ redirect_after_login }}{% endif %}" class="show-new-candidate-form button">{% trans "Sign in to add a new candidate" %}</a></p>
          {% endif %}
        </div>
      {% endfor %} {# end of 'for party, people in parties_and_people' #}

      {% if parties_and_people and candidate_list_edits_allowed %}
        <p><a class="show-new-candidate-form button">{% trans "Add a new candidate" %}</a></p>
      {% endif %}

    {% endwith %}


  </div>

  {% if candidate_list_edits_allowed %}
    <div class="candidates__new" {% if add_candidate_form.errors %}style="display: block"{% endif %}>

      <h4>{% trans "Add a new candidate" %}</h4>

      <form method="post" id="new-candidate-form" action="{% url 'person-create' election=election %}">
        {% csrf_token %}
        <h2>{% trans "Personal details:" %}</h2>

        {% for simple_field in personal_fields %}
        <div class="form-item {% if simple_field.errors %}form-item--errors{% endif %}">
          <p>
            {{ simple_field.label_tag }}
            {{ simple_field }}
          </p>
          {{ simple_field.errors }}
        </div>

        {% endfor %}

        <div>
          <h2>{% trans "Party:" %}</h2>
            {% for field in election_fields %}
              {% if field.is_hidden %}
                {{ field }}
              {% else %}
              <div class="form-item">
                <p>
                  {{ field.errors }}
                  {{ field.label }}
                  {{ field }}
                </p>
              </div>
              {% endif %}
            {% endfor %}
        </div>

        <h2>{% trans "Links and social media:" %}</h2>

        <div class="form-item {% if form.twitter_username.errors %}form-item--errors{% endif %}">
          {{ add_candidate_form.twitter_username.label_tag }}
          <div class="row collapse">
            <div class="small-1 columns">
              <span class="prefix">@</span>
            </div>
            <div class="small-11 columns">
              {{ add_candidate_form.twitter_username }}
            </div>
          </div>
          {{ add_candidate_form.twitter_username.errors }}
        </div>

        <div class="form-item {% if form.facebook_personal_url.errors %}form-item--errors{% endif %}">
          <p>
            {{ add_candidate_form.facebook_personal_url.label_tag }}
            {{ add_candidate_form.facebook_personal_url }}
          </p>
          {{ add_candidate_form.facebook_personal_url.errors }}
        </div>

        <div class="form-item {% if form.facebook_page_url.errors %}form-item--errors{% endif %}">
          <p>
            {{ add_candidate_form.facebook_page_url.label_tag }}
            {{ add_candidate_form.facebook_page_url }}
          </p>
          {{ add_candidate_form.facebook_page_url.errors }}
        </div>

        <div class="form-item {% if form.homepage_url.errors %}form-item--errors{% endif %}">
          <p>
            {{ add_candidate_form.homepage_url.label_tag }}
            {{ add_candidate_form.homepage_url }}
          </p>
          {{ add_candidate_form.homepage_url.errors }}
        </div>

        <div class="form-item {% if form.wikipedia_url.errors %}form-item--errors{% endif %}">
          <p>
            {{ add_candidate_form.wikipedia_url.label_tag }}
            {{ add_candidate_form.wikipedia_url }}
          </p>
          {{ add_candidate_form.wikipedia_url.errors }}
        </div>

        <div class="form-item {% if form.linkedin_url.errors %}form-item--errors{% endif %}">
          <p>
            {{ add_candidate_form.linkedin_url.label_tag }}
            {{ add_candidate_form.linkedin_url }}
          </p>
          {{ add_candidate_form.linkedin_url.errors }}
        </div>

        <div class="form-item {% if form.party_ppc_page_url.errors %}form-item--errors{% endif %}">
          <p>
            {{ add_candidate_form.party_ppc_page_url.label_tag }}
            {{ add_candidate_form.party_ppc_page_url }}
          </p>
          {{ add_candidate_form.party_ppc_page_url.errors }}
        </div>

        <h2>{% trans "Demographics:" %}</h2>

        {% for simple_field in demographic_fields %}
        <div class="form-item {% if simple_field.errors %}form-item--errors{% endif %}">
          <p>
            {{ simple_field.label_tag }}
            {{ simple_field }}
          </p>
          {{ simple_field.errors }}
        </div>

        {% endfor %}

        {% if extra_fields %}

          <h2>{% trans "Additional information:" %}</h2>

          {% for extra_field in extra_fields %}
            <div class="form-item {% if extra_field..errors %}form-item--errors{% endif %}">
              <p>
                {{ extra_field.label }}
                {{ extra_field }}
              </p>
              {{ extra_field.errors }}
            </div>
          {% endfor %}

        {% endif %}

        <div class="source-confirmation {% if form.source.errors %}source-confirmation--errors{% endif %}">
          <p>
            <label for="{{ form.source.id_for_label }}">
              {% if add_candidate_form.source.errors %}
                {% trans "<strong>You forgot to reference a source!</strong> Can you show us <em>where</em> you got this information?" %}
              {% else %}
                {% trans "Whatâ€™s your <strong>source of information</strong> for this candidate?" %}
              {% endif %}
              {{ settings.SOURCE_HINTS }}
            </label>
            {{ add_candidate_form.source }}
          </p>
        </div>
        <input type="submit" class="button" value="{% trans "Add new candidate" %}">
        <a class="hide-new-candidate-form button secondary">{% trans "Cancel" %}</a>
      </form>

    </div>
  {% endif %}

  {% if not candidates_locked %}

    {% if candidacies_might_stand_again.parties_and_people %}
      <div class="candidates__previous">

        {% if user.is_authenticated %}
        <h3>{% trans "Is a candidate from an earlier election standing again?" %}</h3>
        {% else %}
        <h3>{% trans "We don't know if these candidates from earlier elections are standing again" %}</h3>
        {% endif %}

        {% with party_lists_in_use=candidacies_might_stand_again.party_lists_in_use parties_and_people=candidacies_might_stand_again.parties_and_people %}

          {% for party, people in parties_and_people %}

            <div class="party-group {% if party_lists_in_use %}party-list{% else %}no-party-list{% endif %}">

              {% if party_lists_in_use %}
                <h4>{{ party.name }}</h4>
              {% endif %}

              <ul class="candidate-list">
                {% for c, candidate_elected in people %}

                  <li class="candidates-list__person">
                    {% include 'candidates/_person_in_list.html' %}
                    {% if user.is_authenticated %}
                    <p>
                      {% if candidate_list_edits_allowed %}
                        <a class="button tiny js-toggle-source-confirmation standing">{% trans "Standing again" %}</a>
                        <a class="button tiny js-toggle-source-confirmation not-standing">{% trans "Not standing again" %}</a>
                      {% endif %}
                      <a href="{% url 'person-update' person_id=c.id %}" class="button tiny secondary">{% trans "Edit" %}</a>
                    </p>
                    {% if candidate_list_edits_allowed %}
                      {% include 'candidates/_source_confirmation.html' with standing='standing' action='candidacy-create' %}
                      {% include 'candidates/_source_confirmation.html' with standing='not-standing' action='candidacy-delete' %}
                    {% endif %}
                    {% endif %}
                  </li>
                {% endfor %} {# end of 'for c, candidate_elected in people' #}
              </ul>

            </div>

          {% endfor %} {# end of 'party, people in parties_and_people' #}

        {% endwith %}

      </div>
    {% endif %}

    {% if candidacies_not_standing_again.parties_and_people %}
      <div class="candidates__not-standing">

        <h3>{% trans "These candidates from earlier elections are known not to be standing again" %}</h3>

        {% with party_lists_in_use=candidacies_not_standing_again.party_lists_in_use parties_and_people=candidacies_not_standing_again.parties_and_people %}

          {% for party, people in parties_and_people %}

            <div class="party-group {% if party_lists_in_use %}party-list{% else %}no-party-list{% endif %}">

              {% if party_lists_in_use %}
                <h4>{{ party.name }}</h4>
              {% endif %}

              <ul class="candidate-list">
                {% for c, candidate_elected in people %}

                  <li class="candidates-list__person">
                    {% include 'candidates/_person_in_list.html' %}
                    {% if user.is_authenticated %}
                    <p>
                      {% if candidate_list_edits_allowed %}
                        <a class="button tiny js-toggle-source-confirmation standing">{% trans "Actually, they are standing!" %}</a>
                      {% endif %}
                      <a href="{% url 'person-update' person_id=c.id %}" class="button tiny secondary">{% trans "Edit" %}</a>
                    </p>
                    {% if candidate_list_edits_allowed %}
                      {% include 'candidates/_source_confirmation.html' with standing='standing' action='candidacy-create' %}
                    {% endif %}
                    {% endif %}
                  </li>
                {% endfor %} {# end of 'for c, candidate_elected in people' #}
              </ul>

            </div>

          {% endfor %} {# end of 'for party, people in parties_and_people' #}

        {% endwith %}

      </div>
    {% endif %}

  {% endif %} {# end of 'if not candidates_locked' #}
</div>
